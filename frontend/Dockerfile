# ===== BUILDER =====
FROM node:20-bullseye AS builder

WORKDIR /app

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º system deps (–≤–∞–∂–Ω–æ: –±–µ–∑ –Ω–∏—Ö –Ω–µ –ø–µ—Ä–µ—Å–æ–±–µ—Ä—É—Ç—Å—è –Ω–∞—Ç–∏–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
RUN apt-get update && apt-get install -y git python3 make g++ && rm -rf /var/lib/apt/lists/*

# –ö–æ–ø–∏—Ä—É–µ–º package.json
COPY package*.json ./

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN npm install --legacy-peer-deps

# –ö–æ–ø–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ–µ–∫—Ç
COPY . .

# üî• –ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç ‚Äî —É–¥–∞–ª—è–µ–º lightningcss –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
RUN npm uninstall lightningcss || true

# üî• –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã–∫–ª—é—á–∞–µ–º –µ–≥–æ —á–µ—Ä–µ–∑ env
ENV NEXT_TELEMETRY_DISABLED=1
ENV NEXT_DISABLE_LIGHTNINGCSS=1
ENV NODE_ENV=production

# –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
RUN npm run build

# ===== RUNNER =====
FROM node:20-bullseye AS runner
WORKDIR /app
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV NEXT_DISABLE_LIGHTNINGCSS=1

COPY --from=builder /app/package*.json ./
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/node_modules ./node_modules

EXPOSE 3000
CMD ["npm", "start"]
